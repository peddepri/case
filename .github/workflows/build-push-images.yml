name: Build and Push Images

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend
          - mobile

env:
  AWS_REGION: us-east-2

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::918859180133:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build backend
        if: |
          github.event_name == 'push' || 
          (github.event_name == 'workflow_dispatch' && 
           (inputs.service == 'backend' || inputs.service == 'all'))
        run: |
          if [ -f "domains/apps/app/backend/Dockerfile" ]; then
            docker build -t ${{ steps.login-ecr.outputs.registry }}/case-backend:${{ github.sha }} domains/apps/app/backend/
            docker tag ${{ steps.login-ecr.outputs.registry }}/case-backend:${{ github.sha }} ${{ steps.login-ecr.outputs.registry }}/case-backend:latest
            docker push ${{ steps.login-ecr.outputs.registry }}/case-backend:${{ github.sha }}
            docker push ${{ steps.login-ecr.outputs.registry }}/case-backend:latest
            echo "Backend image built and pushed"
          fi

      - name: Build frontend
        if: |
          github.event_name == 'push' || 
          (github.event_name == 'workflow_dispatch' && 
           (inputs.service == 'frontend' || inputs.service == 'all'))
        run: |
          if [ -f "domains/apps/app/frontend/Dockerfile" ]; then
            docker build -t ${{ steps.login-ecr.outputs.registry }}/case-frontend:${{ github.sha }} domains/apps/app/frontend/
            docker tag ${{ steps.login-ecr.outputs.registry }}/case-frontend:${{ github.sha }} ${{ steps.login-ecr.outputs.registry }}/case-frontend:latest
            docker push ${{ steps.login-ecr.outputs.registry }}/case-frontend:${{ github.sha }}
            docker push ${{ steps.login-ecr.outputs.registry }}/case-frontend:latest
            echo "Frontend image built and pushed"
          fi

      - name: Build mobile
        if: |
          github.event_name == 'push' || 
          (github.event_name == 'workflow_dispatch' && 
           (inputs.service == 'mobile' || inputs.service == 'all'))
        run: |
          if [ -f "domains/apps/app/mobile/Dockerfile" ]; then
            docker build -t ${{ steps.login-ecr.outputs.registry }}/case-mobile:${{ github.sha }} domains/apps/app/mobile/
            docker tag ${{ steps.login-ecr.outputs.registry }}/case-mobile:${{ github.sha }} ${{ steps.login-ecr.outputs.registry }}/case-mobile:latest
            docker push ${{ steps.login-ecr.outputs.registry }}/case-mobile:${{ github.sha }}
            docker push ${{ steps.login-ecr.outputs.registry }}/case-mobile:latest
            echo "Mobile image built and pushed"
          fi