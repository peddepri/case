name: Build & Push Images (Enhanced)

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to build"
        required: true
        type: choice
        options:
          - backend
          - frontend
          - mobile
          - all
        default: all
      debug:
        description: "Enable debug mode"
        required: false
        type: boolean
        default: false
  push:
    branches: [main]
    paths:
      - 'domains/apps/app/**'

env:
  AWS_REGION: us-east-2

jobs:
  # Job to check prerequisites
  check-prerequisites:
    runs-on: ubuntu-latest
    outputs:
      has-role-secret: ${{ steps.check-secrets.outputs.has-role-secret }}
      backend-exists: ${{ steps.check-dirs.outputs.backend-exists }}
      frontend-exists: ${{ steps.check-dirs.outputs.frontend-exists }}
      mobile-exists: ${{ steps.check-dirs.outputs.mobile-exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check secrets and directories
        id: check-secrets
        run: |
          # Check if AWS_ROLE_TO_ASSUME secret exists (indirectly)
          if [ -n "${{ secrets.AWS_ROLE_TO_ASSUME }}" ]; then
            echo "has-role-secret=true" >> $GITHUB_OUTPUT
          else
            echo "has-role-secret=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è AWS_ROLE_TO_ASSUME secret n√£o configurado!"
          fi

      - name: Check application directories
        id: check-dirs
        run: |
          # Check if directories and Dockerfiles exist
          if [ -f "domains/apps/app/backend/Dockerfile" ]; then
            echo "backend-exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Backend Dockerfile encontrado"
          else
            echo "backend-exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Backend Dockerfile n√£o encontrado"
          fi
          
          if [ -f "domains/apps/app/frontend/Dockerfile" ]; then
            echo "frontend-exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Frontend Dockerfile encontrado"
          else
            echo "frontend-exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Frontend Dockerfile n√£o encontrado"
          fi
          
          if [ -f "domains/apps/app/mobile/Dockerfile" ]; then
            echo "mobile-exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Mobile Dockerfile encontrado"
          else
            echo "mobile-exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Mobile Dockerfile n√£o encontrado"
          fi

      - name: Debug information
        if: inputs.debug == true
        run: |
          echo "=== DEBUG INFORMATION ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Service input: ${{ inputs.service }}"
          echo "Has AWS role secret: ${{ steps.check-secrets.outputs.has-role-secret }}"
          echo "Repository structure:"
          find domains/apps/app -type f -name "Dockerfile*" | head -10

  # Backend build job
  build-backend:
    needs: check-prerequisites
    if: |
      needs.check-prerequisites.outputs.has-role-secret == 'true' && 
      needs.check-prerequisites.outputs.backend-exists == 'true' && (
        github.event_name == 'push' || 
        (github.event_name == 'workflow_dispatch' && (inputs.service == 'backend' || inputs.service == 'all'))
      )
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Backend-${{ github.run_id }}

      - name: Verify AWS credentials
        run: |
          echo "=== AWS Identity ==="
          aws sts get-caller-identity
          echo "=== ECR Repositories ==="
          aws ecr describe-repositories --region ${{ env.AWS_REGION }} --repository-names case-backend || echo "Repository case-backend not found"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: case-backend
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "=== Building Backend Image ==="
          echo "Registry: $ECR_REGISTRY"
          echo "Repository: $ECR_REPOSITORY"
          echo "Tag: $IMAGE_TAG"
          
          # Build and push Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG domains/apps/app/backend/
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "Pushing images..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "‚úÖ Backend image pushed successfully"
          echo "Image URI: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

  # Frontend build job
  build-frontend:
    needs: check-prerequisites
    if: |
      needs.check-prerequisites.outputs.has-role-secret == 'true' && 
      needs.check-prerequisites.outputs.frontend-exists == 'true' && (
        github.event_name == 'push' || 
        (github.event_name == 'workflow_dispatch' && (inputs.service == 'frontend' || inputs.service == 'all'))
      )
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Frontend-${{ github.run_id }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push frontend image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: case-frontend
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "=== Building Frontend Image ==="
          
          # Build and push Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            --build-arg VITE_BACKEND_URL=/api \
            domains/apps/app/frontend/
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "Pushing images..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "‚úÖ Frontend image pushed successfully"

  # Mobile build job
  build-mobile:
    needs: check-prerequisites
    if: |
      needs.check-prerequisites.outputs.has-role-secret == 'true' && 
      needs.check-prerequisites.outputs.mobile-exists == 'true' && (
        github.event_name == 'push' || 
        (github.event_name == 'workflow_dispatch' && (inputs.service == 'mobile' || inputs.service == 'all'))
      )
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Mobile-${{ github.run_id }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push mobile image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: case-mobile
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "=== Building Mobile Image ==="
          
          # Build and push Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG domains/apps/app/mobile/
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "Pushing images..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "‚úÖ Mobile image pushed successfully"

  # Summary job
  build-summary:
    needs: [check-prerequisites, build-backend, build-frontend, build-mobile]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Build Summary
        run: |
          echo "=== Build Summary ==="
          echo "Prerequisites check: ${{ needs.check-prerequisites.result }}"
          echo "Backend build: ${{ needs.build-backend.result }}"
          echo "Frontend build: ${{ needs.build-frontend.result }}"
          echo "Mobile build: ${{ needs.build-mobile.result }}"
          echo ""
          
          if [ "${{ needs.check-prerequisites.outputs.has-role-secret }}" != "true" ]; then
            echo "‚ùå ERRO: Secret AWS_ROLE_TO_ASSUME n√£o configurado!"
            echo ""
            echo "üìã Para corrigir:"
            echo "1. V√° para: https://github.com/peddepri/case/settings/secrets/actions"
            echo "2. Clique em 'New repository secret'"
            echo "3. Nome: AWS_ROLE_TO_ASSUME"
            echo "4. Valor: arn:aws:iam::918859180133:role/GitHubActionsRole"
            echo "5. Clique em 'Add secret'"
            echo ""
          fi
          
          echo "‚úÖ Para testar novamente, execute este workflow com debug=true"