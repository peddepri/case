{{- if .Values.adot.enabled }}
apiVersion: v1
kind: Namespace
metadata:
  name: observability
  labels:
    app: adot
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: adot-collector-config
  namespace: observability
  labels:
    app: adot
data:
  adot-config.yaml: |
    receivers:
      prometheus:
        config:
          scrape_configs:
            - job_name: 'kubernetes-pods'
              kubernetes_sd_configs:
                - role: pod
              relabel_configs:
                - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                  action: keep
                  regex: true
                - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                  action: replace
                  target_label: __metrics_path__
                  regex: (.+)
                - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
                  action: replace
                  target_label: __address__
                  regex: (\d+)
                  replacement: $1
    processors:
      batch: {}
      memory_limiter:
        check_interval: 30s
        limit_mib: 256
        spike_limit_mib: 64
    exporters:
      awscloudwatch:
        region: {{ .Values.adot.region | quote }}
        namespace: {{ .Values.adot.metricsNamespace | quote }}
        dimension_rollup_option: NoDimensionRollup
        create_namespace: true
      logging:
        loglevel: warn
    service:
      pipelines:
        metrics:
          receivers: [prometheus]
          processors: [memory_limiter, batch]
          exporters: [awscloudwatch]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adot-collector
  namespace: observability
  labels:
    app: adot-collector
spec:
  replicas: 1
  selector:
    matchLabels:
      app: adot-collector
  template:
    metadata:
      labels:
        app: adot-collector
    spec:
      serviceAccountName: adot-collector-sa
      containers:
        - name: adot-collector
          image: public.ecr.aws/aws-observability/aws-otel-collector:latest
          args: ["--config=/etc/collector/adot-config.yaml"]
          resources:
            requests:
              cpu: {{ .Values.adot.resources.requests.cpu | quote }}
              memory: {{ .Values.adot.resources.requests.memory | quote }}
            limits:
              cpu: {{ .Values.adot.resources.limits.cpu | quote }}
              memory: {{ .Values.adot.resources.limits.memory | quote }}
          volumeMounts:
            - name: config
              mountPath: /etc/collector
      volumes:
        - name: config
          configMap:
            name: adot-collector-config
{{- end }}