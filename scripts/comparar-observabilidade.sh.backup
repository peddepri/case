#!/bin/bash

# Script para comparar stacks de observabilidade: Datadog vs Grafana
# Uso: ./comparar-observabilidade.sh [datadog|grafana|hibrido|custos]

function show_datadog_stack() {
    echo "🐕 DATADOG SaaS STACK"
    echo "===================="
    echo ""
    echo "📊 Componentes:"
    echo "   • APM Agentless (dd-trace)"
    echo "   • Infrastructure Monitoring"
    echo "   • Log Management"
    echo "   • Real User Monitoring (RUM)"
    echo "   • Synthetic Monitoring"
    echo "   • AI-powered Alerts"
    echo ""
    echo "✅ Vantagens:"
    echo "   • Zero maintenance"
    echo "   • Rich feature set"
    echo "   • Auto-correlation"
    echo "   • Enterprise support"
    echo "   • Quick time-to-value"
    echo ""
    echo "❌ Desvantagens:"
    echo "   • Alto custo (~$325/mês)"
    echo "   • Vendor lock-in"
    echo "   • Limited customization"
    echo "   • Data sovereignty concerns"
    echo ""
    echo "🎯 Melhor para:"
    echo "   • Produção crítica (24/7 SLA)"
    echo "   • Times pequenos"
    echo "   • Foco em MTTR"
    echo "   • Executive dashboards"
}

function show_grafana_stack() {
    echo "🔶 GRAFANA STACK"
    echo "================"
    echo ""
    echo "📊 Componentes:"
    echo "   • Prometheus (metrics + alerts)"
    echo "   • Grafana (dashboards)"
    echo "   • Loki (log aggregation)"
    echo "   • Tempo (distributed tracing)"
    echo "   • Promtail (log shipping)"
    echo "   • AlertManager (notifications)"
    echo ""
    echo "✅ Vantagens:"
    echo "   • Open source ecosystem"
    echo "   • Cost-effective (~$65/mês)"
    echo "   • Full customization"
    echo "   • No vendor lock-in"
    echo "   • Long-term data retention"
    echo ""
    echo "❌ Desvantagens:"
    echo "   • High operational overhead"
    echo "   • Complex setup"
    echo "   • Requires expertise"
    echo "   • Manual scaling"
    echo ""
    echo "🎯 Melhor para:"
    echo "   • Cost-conscious teams"
    echo "   • Custom requirements"
    echo "   • Learning/development"
    echo "   • Compliance needs"
}

function show_hybrid_strategy() {
    echo "🔄 ESTRATÉGIA HÍBRIDA"
    echo "====================="
    echo ""
    echo "🎯 Abordagem Recomendada:"
    echo ""
    echo "📈 PRODUÇÃO (Critical Path):"
    echo "   Primary:   Datadog SaaS"
    echo "   • Critical alerting (PagerDuty)"
    echo "   • Executive dashboards"
    echo "   • APM correlation"
    echo "   • 24/7 SLA support"
    echo ""
    echo "   Secondary: Grafana Stack"
    echo "   • Cost analysis (FinOps)"
    echo "   • Historical data (compliance)"
    echo "   • Custom business metrics"
    echo "   • Performance debugging"
    echo ""
    echo "🧪 STAGING/DEVELOPMENT:"
    echo "   Primary:   Grafana Stack"
    echo "   • Cost-effective development"
    echo "   • Learning playground"
    echo "   • Custom integrations"
    echo "   • Performance testing"
    echo ""
    echo "💡 Benefícios da Estratégia:"
    echo "   • 📉 37% redução de custos vs Datadog puro"
    echo "   • 🚨 Zero compromisso em alertas críticos"
    echo "   • 📊 Flexibilidade para análises customizadas"
    echo "   • 🎓 Path de migração gradual"
    echo "   • 📋 Compliance com retenção longa"
}

function show_cost_comparison() {
    echo "💰 COMPARAÇÃO DE CUSTOS (mensal)"
    echo "================================="
    echo ""
    echo "📊 DATADOG SaaS:"
    echo "   APM (5 hosts):        $155"
    echo "   Log Ingestion (100GB): $110"  
    echo "   Custom Metrics:        $60"
    echo "   ────────────────────────────"
    echo "   Total Datadog:        $325"
    echo ""
    echo "🔶 GRAFANA STACK:"
    echo "   Prometheus (EKS):      $30"
    echo "   Grafana (EKS):         $15"
    echo "   Loki (EKS):            $15"
    echo "   Tempo (EKS):           $15"
    echo "   S3 Storage:            $10"
    echo "   ────────────────────────────"
    echo "   Total Grafana:         $65"
    echo ""
    echo "🔄 ESTRATÉGIA HÍBRIDA:"
    echo "   Production (DD+GF):    $280"
    echo "   Staging (Grafana):     $65"
    echo "   Development (Grafana): $65"
    echo "   ────────────────────────────"
    echo "   Total Híbrido:        $410"
    echo ""
    echo "📈 ECONOMIA:"
    echo "   Grafana vs Datadog:   80% economia"
    echo "   Híbrido vs Datadog:   37% economia"
    echo ""
    echo "⚠️  CUSTOS OCULTOS (Grafana):"
    echo "   Setup inicial:         $2,000-5,000"
    echo "   Operational (SRE):     $3,000-5,000/mês"
    echo "   Training:              $2,000-8,000"
    echo ""
    echo "💡 RECOMENDAÇÃO:"
    echo "   • Start: Datadog (time-to-market)"
    echo "   • Scale: Híbrido (cost optimization)"
    echo "   • Mature: Avalie migração gradual"
}

function show_implementation_guide() {
    echo "🚀 GUIA DE IMPLEMENTAÇÃO"
    echo "========================"
    echo ""
    echo "📋 FASE 1: Datadog Setup (Semana 1-2)"
    echo "   1. Deploy Datadog Cluster Agent"
    echo "   2. Configure APM agentless"
    echo "   3. Setup CloudWatch log forwarding"
    echo "   4. Create Golden Signals dashboards"
    echo "   5. Configure critical alerts"
    echo ""
    echo "📋 FASE 2: Grafana Pilot (Semana 3-6)"
    echo "   1. Deploy Prometheus + Grafana"
    echo "   2. Configure /metrics scraping"
    echo "   3. Setup Loki + Promtail"
    echo "   4. Implement OpenTelemetry (Tempo)"
    echo "   5. Create custom dashboards"
    echo ""
    echo "📋 FASE 3: Estratégia Híbrida (Semana 7-8)"
    echo "   1. Dual-instrument applications"
    echo "   2. Route critical alerts to Datadog"
    echo "   3. Route analytics to Grafana"
    echo "   4. Setup cost monitoring"
    echo "   5. Train team on both stacks"
    echo ""
    echo "📋 FASE 4: Otimização (Ongoing)"
    echo "   1. Monitor costs vs value"
    echo "   2. Adjust sampling rates"
    echo "   3. Optimize retention policies"
    echo "   4. Evaluate migration paths"
    echo "   5. Regular stack health checks"
    echo ""
    echo "🔧 Ferramentas de Deploy:"
    echo "   • Datadog: Helm chart"
    echo "   • Grafana: kube-prometheus-stack"
    echo "   • Terraform: observability.tf module"
    echo "   • GitOps: ArgoCD applications"
}

function show_help() {
    echo "🔍 COMPARAÇÃO DE STACKS DE OBSERVABILIDADE"
    echo "==========================================="
    echo ""
    echo "📋 Uso: $0 [opção]"
    echo ""
    echo "🎯 Opções disponíveis:"
    echo "   datadog     - Mostra detalhes da stack Datadog SaaS"
    echo "   grafana     - Mostra detalhes da stack Grafana"
    echo "   hibrido     - Estratégia híbrida recomendada"
    echo "   custos      - Comparação detalhada de custos"
    echo "   implementar - Guia de implementação por fases"
    echo "   help        - Mostra esta ajuda"
    echo ""
    echo "📊 Contexto do Projeto:"
    echo "   • Ambiente: AWS EKS Fargate + DynamoDB"
    echo "   • Aplicações: Backend Node.js + Frontend React + Mobile Expo"
    echo "   • Escala: 5 hosts, 100GB logs/mês, métricas customizadas"
    echo "   • Requisitos: 99.9% SLA, alertas 24/7, dashboards executivos"
    echo ""
    echo "📚 Referências:"
    echo "   • Arquiteturas: docs/producao/arquitetura-*.drawio"
    echo "   • Configurações: observabilidade/"
    echo "   • Custos: docs/producao/arquitetura-diagramas-mermaid.md"
}

# Processar argumentos
case "${1:-help}" in
    "datadog"|"dd")
        show_datadog_stack
        ;;
    
    "grafana"|"graf"|"prometheus")
        show_grafana_stack
        ;;
    
    "hibrido"|"hybrid"|"mix")
        show_hybrid_strategy
        ;;
    
    "custos"|"costs"|"financeiro")
        show_cost_comparison
        ;;
    
    "implementar"|"deploy"|"setup")
        show_implementation_guide
        ;;
    
    "help"|"-h"|"--help")
        show_help
        ;;
    
    *)
        echo "❌ Opção inválida: $1"
        echo ""
        show_help
        exit 1
        ;;
esac

echo ""
echo "🏗️  Arquitetura de Produção AWS EKS + Observabilidade"
echo "📍 Documentação: docs/producao/"
echo "⚡ Stack atual: Datadog SaaS + Grafana Stack (híbrido)"